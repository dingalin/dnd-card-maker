(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const n of document.querySelectorAll('link[rel="modulepreload"]'))a(n);new MutationObserver(n=>{for(const o of n)if(o.type==="childList")for(const i of o.addedNodes)i.tagName==="LINK"&&i.rel==="modulepreload"&&a(i)}).observe(document,{childList:!0,subtree:!0});function t(n){const o={};return n.integrity&&(o.integrity=n.integrity),n.referrerPolicy&&(o.referrerPolicy=n.referrerPolicy),n.crossOrigin==="use-credentials"?o.credentials="include":n.crossOrigin==="anonymous"?o.credentials="omit":o.credentials="same-origin",o}function a(n){if(n.ep)return;n.ep=!0;const o=t(n);fetch(n.href,o)}})();window.OFFICIAL_ITEMS={weapon:{"Simple Melee":["Club (××œ×”)","Dagger (×¤×’×™×•×Ÿ)","Greatclub (××œ×” ×’×“×•×œ×”)","Handaxe (×’×¨×–×Ÿ ×™×“)","Javelin (×›×™×“×•×Ÿ)","Light Hammer (×¤×˜×™×© ×§×œ)","Mace (××œ×ª ×§×¨×‘)","Quarterstaff (××˜×”)","Sickle (××’×œ)","Spear (×—× ×™×ª)"],"Simple Ranged":["Light Crossbow (×¨×•×‘×” ×§×©×ª ×§×œ)","Dart (×—×¥ ×”×˜×œ×”)","Shortbow (×§×©×ª ×§×¦×¨×”)","Sling (×§×œ×¢)"],"Martial Melee":["Battleaxe (×’×¨×–×Ÿ ×§×¨×‘)","Flail (××•×¨×’)","Glaive (×’×œ×™×™×‘)","Greataxe (×’×¨×–×Ÿ ×“×•-×™×“× ×™)","Greatsword (×—×¨×‘ ×“×•-×™×“× ×™×ª)","Halberd (×”×œ×‘××¨×“)","Lance (×¨×•××—)","Longsword (×—×¨×‘ ××¨×•×›×”)","Maul (×¤×˜×™×© ×§×¨×‘)","Morningstar (×›×•×›×‘ ×©×—×¨)","Pike (×¨×•××— ×¨×’×œ×™×)","Rapier (×¡×™×£)","Scimitar (×—×¨×‘ ××¢×•×§×œ×ª)","Shortsword (×—×¨×‘ ×§×¦×¨×”)","Trident (×§×œ×©×•×Ÿ)","War Pick (××›×•×© ××œ×—××”)","Warhammer (×§×•×¨× ×¡)"],"Martial Ranged":["Blowgun (×¨×•×‘×” × ×©×™×¤×”)","Hand Crossbow (×¨×•×‘×” ×§×©×ª ×™×“)","Heavy Crossbow (×¨×•×‘×” ×§×©×ª ×›×‘×“)","Longbow (×§×©×ª ××¨×•×›×”)","Net (×¨×©×ª)"]},armor:{"Light Armor":["Padded (××¨×•×¤×“)","Leather (×¢×•×¨)","Studded Leather (×¢×•×¨ ××—×•×–×§)"],"Medium Armor":["Hide (×¤×¨×•×•×”)","Chain Shirt (×—×•×œ×¦×ª ×©×¨×©×¨××•×ª)","Scale Mail (×©×¨×™×•×Ÿ ×§×©×§×©×™×)","Breastplate (×©×¨×™×•×Ÿ ×—×–×”)","Half Plate (×—×¦×™ ×œ×•×—×•×ª)"],"Heavy Armor":["Ring Mail (×©×¨×™×•×Ÿ ×˜×‘×¢×•×ª)","Chain Mail (×©×¨×™×•×Ÿ ×©×¨×©×¨××•×ª)","Splint (×©×¨×™×•×Ÿ ×¨×¦×•×¢×•×ª)","Plate (×©×¨×™×•×Ÿ ×œ×•×—×•×ª)"],Shield:["Shield (××’×Ÿ)"]},potion:{Potions:["Healing (×¨×™×¤×•×™)","Climbing (×˜×™×¤×•×¡)","Invisibility (×”×™×¢×œ××•×ª)","Speed (××”×™×¨×•×ª)","Water Breathing (× ×©×™××” ×‘××™×)","Giant Strength (×›×•×— ×¢× ×§×™×)"]},ring:{Rings:["Protection (×”×’× ×”)","Invisibility (×”×™×¢×œ××•×ª)","Feather Falling (× ×¤×™×œ×ª × ×•×¦×”)","Regeneration (×”×ª×—×“×©×•×ª)"]},wondrous:{Worn:["Amulet (×§××¢)","Belt (×—×’×•×¨×”)","Boots (××’×¤×™×™×)","Cloak (×’×œ×™××”)","Gloves (×›×¤×¤×•×ª)","Helmet (×§×¡×“×”)"],Held:["Bag (×ª×™×§)","Gem (××‘×Ÿ ×—×Ÿ)","Wand (×©×¨×‘×™×˜)","Rod (××•×˜)","Staff (××˜×” ×§×¡×)"]}};window.ITEM_STATS={"Club (××œ×”)":{damage:"1d4",damageType:"bludgeoning"},"Dagger (×¤×’×™×•×Ÿ)":{damage:"1d4",damageType:"piercing"},"Greatclub (××œ×” ×’×“×•×œ×”)":{damage:"1d8",damageType:"bludgeoning"},"Handaxe (×’×¨×–×Ÿ ×™×“)":{damage:"1d6",damageType:"slashing"},"Javelin (×›×™×“×•×Ÿ)":{damage:"1d6",damageType:"piercing"},"Light Hammer (×¤×˜×™×© ×§×œ)":{damage:"1d4",damageType:"bludgeoning"},"Mace (××œ×ª ×§×¨×‘)":{damage:"1d6",damageType:"bludgeoning"},"Quarterstaff (××˜×”)":{damage:"1d6",damageType:"bludgeoning"},"Sickle (××’×œ)":{damage:"1d4",damageType:"slashing"},"Spear (×—× ×™×ª)":{damage:"1d6",damageType:"piercing"},"Light Crossbow (×¨×•×‘×” ×§×©×ª ×§×œ)":{damage:"1d8",damageType:"piercing"},"Dart (×—×¥ ×”×˜×œ×”)":{damage:"1d4",damageType:"piercing"},"Shortbow (×§×©×ª ×§×¦×¨×”)":{damage:"1d6",damageType:"piercing"},"Sling (×§×œ×¢)":{damage:"1d4",damageType:"bludgeoning"},"Battleaxe (×’×¨×–×Ÿ ×§×¨×‘)":{damage:"1d8",damageType:"slashing"},"Flail (××•×¨×’)":{damage:"1d8",damageType:"bludgeoning"},"Glaive (×’×œ×™×™×‘)":{damage:"1d10",damageType:"slashing"},"Greataxe (×’×¨×–×Ÿ ×“×•-×™×“× ×™)":{damage:"1d12",damageType:"slashing"},"Greatsword (×—×¨×‘ ×“×•-×™×“× ×™×ª)":{damage:"2d6",damageType:"slashing"},"Halberd (×”×œ×‘××¨×“)":{damage:"1d10",damageType:"slashing"},"Lance (×¨×•××—)":{damage:"1d12",damageType:"piercing"},"Longsword (×—×¨×‘ ××¨×•×›×”)":{damage:"1d8",damageType:"slashing"},"Maul (×¤×˜×™×© ×§×¨×‘)":{damage:"2d6",damageType:"bludgeoning"},"Morningstar (×›×•×›×‘ ×©×—×¨)":{damage:"1d8",damageType:"piercing"},"Pike (×¨×•××— ×¨×’×œ×™×)":{damage:"1d10",damageType:"piercing"},"Rapier (×¡×™×£)":{damage:"1d8",damageType:"piercing"},"Scimitar (×—×¨×‘ ××¢×•×§×œ×ª)":{damage:"1d6",damageType:"slashing"},"Shortsword (×—×¨×‘ ×§×¦×¨×”)":{damage:"1d6",damageType:"piercing"},"Trident (×§×œ×©×•×Ÿ)":{damage:"1d6",damageType:"piercing"},"War Pick (××›×•×© ××œ×—××”)":{damage:"1d8",damageType:"piercing"},"Warhammer (×§×•×¨× ×¡)":{damage:"1d8",damageType:"bludgeoning"},"Blowgun (×¨×•×‘×” × ×©×™×¤×”)":{damage:"1",damageType:"piercing"},"Hand Crossbow (×¨×•×‘×” ×§×©×ª ×™×“)":{damage:"1d6",damageType:"piercing"},"Heavy Crossbow (×¨×•×‘×” ×§×©×ª ×›×‘×“)":{damage:"1d10",damageType:"piercing"},"Longbow (×§×©×ª ××¨×•×›×”)":{damage:"1d8",damageType:"piercing"},"Net (×¨×©×ª)":{damage:"-",damageType:"-"},"Padded (××¨×•×¤×“)":{ac:"11"},"Leather (×¢×•×¨)":{ac:"11"},"Studded Leather (×¢×•×¨ ××—×•×–×§)":{ac:"12"},"Hide (×¤×¨×•×•×”)":{ac:"12"},"Chain Shirt (×—×•×œ×¦×ª ×©×¨×©×¨××•×ª)":{ac:"13"},"Scale Mail (×©×¨×™×•×Ÿ ×§×©×§×©×™×)":{ac:"14"},"Breastplate (×©×¨×™×•×Ÿ ×—×–×”)":{ac:"14"},"Half Plate (×—×¦×™ ×œ×•×—×•×ª)":{ac:"15"},"Ring Mail (×©×¨×™×•×Ÿ ×˜×‘×¢×•×ª)":{ac:"14"},"Chain Mail (×©×¨×™×•×Ÿ ×©×¨×©×¨××•×ª)":{ac:"16"},"Splint (×©×¨×™×•×Ÿ ×¨×¦×•×¢×•×ª)":{ac:"17"},"Plate (×©×¨×™×•×Ÿ ×œ×•×—×•×ª)":{ac:"18"},"Shield (××’×Ÿ)":{ac:"+2"}};console.log("GeminiService module loaded (Raw Fetch Version)");const we="https://dnd-api-proxy.dingalin2000.workers.dev/";class oe{constructor(e){e.startsWith("AIza")?(this.apiKey=e,this.useWorker=!1):(this.password=e,this.useWorker=!0,console.log("GeminiService: Using Worker proxy mode ğŸ”")),this.baseUrl="https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent"}async callViaWorker(e,t){const a=await fetch(we,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({password:this.password,action:e,data:t})});if(!a.ok){const n=await a.json();throw new Error(n.error||"Worker request failed")}return a.json()}async generateItemDetails(e,t,a,n,o,i=null){var s;let c=`
      You are a D&D 5e Dungeon Master. Create a unique magic item in Hebrew.
      
      Parameters:
      - Level/Power: ${e}
      - Main Type: ${t}
      - Subtype/Specific Kind: ${a||"Any appropriate for Main Type"}
      - Rarity: ${n}
      - Special Theme/Ability: ${o||"Random cool theme"}
      `;i&&(c+=`
      VISUAL CONTEXT PROVIDED:
      The user has provided an image (attached). Use this image as the primary inspiration for the item's appearance, theme, and flavor.
      - Describe the item based on what you see in the image.
      - If the image shows a specific material (e.g., bone, crystal, gold), use that.
      - If the image implies a specific element (e.g., fire, ice, necrotic), use that.
      `),c+=`
      CRITICAL INSTRUCTION:
      - You MUST strictly adhere to the provided 'Type' and 'Subtype'.
      - VISUAL PROMPT RULES:
        1. The 'visualPrompt' MUST start with the physical object description (e.g., "A glowing blue ring...", "A glass potion bottle...").
        2. NEGATIVE CONSTRAINTS:
           - If Type is 'Ring', do NOT describe a bottle, potion, weapon, or armor.
           - If Type is 'Potion', do NOT describe jewelry, weapons, or armor.
           - If Type is 'Armor', do NOT describe a shield or helmet unless explicitly asked.
           - If Type is 'Weapon', do NOT describe a potion or ring.
      
      - If Type is 'Potion' (or contains 'Potion'), the item MUST be a consumable liquid in a bottle/vial.
      - If Type is 'Ring' (or contains 'Ring'), it MUST be a finger ring.
      - If Type is 'Scroll', it MUST be a parchment scroll.
      - If Type is 'Wondrous Item', it can be anything, but respect the Subtype if provided.
      - If the Type is 'Armor' or a specific armor type (e.g. 'Leather', 'Chain Mail', 'Plate'), you MUST create BODY ARMOR (Chest/Torso). Do NOT create gloves, boots, helmets, or shields unless the 'Special Theme' explicitly asks for them.
      - If the Type is 'Weapon', create a weapon.

      Return ONLY a JSON object with this exact structure (no markdown, just raw JSON):
      {
        "name": "Hebrew Name",
        "typeHe": "Hebrew Type (e.g. × ×©×§, ×©×¨×™×•×Ÿ, ×©×™×§×•×™, ×˜×‘×¢×ª)",
        "rarityHe": "Hebrew Rarity",
        "abilityName": "Hebrew Ability Name",
        "abilityDesc": "Hebrew Ability Description (max 30 words)",
        "description": "Hebrew Fluff Description (max 20 words)",
        "gold": "Estimated price in GP (number only, e.g. 500)",
        "weaponDamage": "Damage dice (e.g. 1d8) if weapon, else null",
        "damageType": "Damage type (Hebrew) if weapon, else null",
        "armorClass": "AC value (number) if armor, else null",
        "visualPrompt": "A highly detailed English description of the item for an image generator. Focus on visual details, materials, lighting, and style. The object should be centered. No text in image."
      }
    `;const d=[{text:c}];if(i)try{let m=i,y="image/jpeg";if(i.startsWith("http")||i.startsWith("blob:")){const r=await(await fetch(i)).blob();y=r.type;const h=await r.arrayBuffer();m=btoa(new Uint8Array(h).reduce((S,b)=>S+String.fromCharCode(b),""))}else if(i.startsWith("data:")){const f=i.match(/^data:(.+);base64,(.+)$/);f&&(y=f[1],m=f[2])}d.push({inline_data:{mime_type:y,data:m}}),console.log("GeminiService: Added visual context to prompt")}catch(m){console.error("Failed to process context image:",m)}const l={contents:[{parts:d}]};try{console.log("Sending Gemini Request. Payload size:",JSON.stringify(l).length);let m;if(this.useWorker)m=await this.callViaWorker("gemini-generate",{model:"gemini-2.0-flash",contents:l.contents,generationConfig:l.generationConfig});else{const r=await fetch(`${this.baseUrl}?key=${this.apiKey}`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(l)});if(!r.ok){const h=await r.json();throw new Error(((s=h.error)==null?void 0:s.message)||"Gemini API request failed")}m=await r.json()}const f=m.candidates[0].content.parts[0].text.replace(/```json/g,"").replace(/```/g,"").trim();return JSON.parse(f)}catch(m){if(i)return console.warn("Gemini API request failed with context image. Retrying without image...",m),this.generateItemDetails(e,t,a,n,o,null);throw console.error("Text Generation Error:",m),new Error(m.message||"Failed to generate item details")}}async generateItemImage(e,t="flux",a="realistic",n="natural",o="#ffffff"){const c={realistic:"",watercolor:"watercolor painting, art line, defined edges, ink outline, artistic, colorful",oil:"oil painting, classic fantasy art, detailed brushstrokes, rich colors",sketch:"pencil sketch, graphite, technical drawing, on paper, monochrome",dark_fantasy:"dark fantasy, gothic, grim, high contrast, moody lighting, elden ring style",anime:"anime style, cel shaded, vibrant, studio ghibli style",woodcut:"woodcut print, old book illustration, black and white, ink lines",pixel:"pixel art, 16-bit, retro game asset",simple_icon:"simple vector icon, flat design, minimal, white background, high contrast, symbol"}[a]||"";let d=`detailed cinematic ${o} background, atmospheric, context appropriate`;n==="no-background"?d="isolated on white background":n==="colored-background"&&(d=`solid ${o} background`);const l=e.substring(0,150).replace(/[^a-zA-Z0-9, ]/g,""),s=encodeURIComponent(`${c}, ${l}, ${d}, medieval fantasy style, D&D equipment, 8k`);let m=`model=${t}`;const y=`https://image.pollinations.ai/prompt/${s}?width=512&height=512&${m}&seed=${Math.floor(Math.random()*1e4)}`;console.log(`GeminiService: Generated Prompt: "${decodeURIComponent(s)}"`),console.log(`GeminiService: Fetching image from (${t}) with style (${a})`,y);try{const f=new AbortController,r=setTimeout(()=>f.abort(),3e4),h=await fetch(y,{signal:f.signal});if(clearTimeout(r),!h.ok)throw new Error(`${t} generation failed: ${h.status}`);const S=await h.blob();return URL.createObjectURL(S)}catch(f){console.warn("FLUX Image Generation Error, trying default model:",f);const r=`https://image.pollinations.ai/prompt/${s}?width=512&height=512&seed=${Math.floor(Math.random()*1e4)}`;console.log("GeminiService: Fetching image from (Default)",r);try{const h=new AbortController,S=setTimeout(()=>h.abort(),3e4),b=await fetch(r,{signal:h.signal});if(clearTimeout(S),!b.ok)throw new Error(`Default generation failed: ${b.status}`);const w=await b.blob();return URL.createObjectURL(w)}catch(h){return console.error("All Image Generation failed:",h),`https://placehold.co/400x400/222/d4af37?text=${encodeURIComponent(e.substring(0,20))}`}}}async removeWhiteBackground(e){return new Promise((t,a)=>{const n=setTimeout(()=>{console.warn("Background removal timed out, returning original"),t(URL.createObjectURL(e))},3e3),o=new Image;o.crossOrigin="Anonymous",o.onload=()=>{clearTimeout(n);try{const i=document.createElement("canvas");i.width=o.width,i.height=o.height;const c=i.getContext("2d");c.drawImage(o,0,0);const d=c.getImageData(0,0,i.width,i.height),l=d.data;for(let s=0;s<l.length;s+=4){const m=l[s],y=l[s+1],f=l[s+2];m>240&&y>240&&f>240&&(l[s+3]=0)}c.putImageData(d,0,0),t(i.toDataURL("image/png"))}catch(i){console.error("Canvas processing error:",i),t(URL.createObjectURL(e))}},o.onerror=i=>{clearTimeout(n),console.error("Image load error for processing:",i),t(URL.createObjectURL(e))},o.src=URL.createObjectURL(e)})}async generateImageGetImg(e,t,a,n,o="natural",i="#ffffff"){var f;const d={realistic:"",watercolor:"watercolor painting, art line, defined edges, ink outline, artistic, colorful",oil:"oil painting, classic fantasy art, detailed brushstrokes, rich colors",sketch:"pencil sketch, graphite, technical drawing, on paper, monochrome",dark_fantasy:"dark fantasy, gothic, grim, high contrast, moody lighting, elden ring style",anime:"anime style, cel shaded, vibrant, studio ghibli style",woodcut:"woodcut print, old book illustration, black and white, ink lines",pixel:"pixel art, 16-bit, retro game asset",simple_icon:"simple vector icon, flat design, minimal, white background, high contrast, symbol"}[a]||"";let l=`detailed cinematic ${i} background, atmospheric, context appropriate`;o==="no-background"?l="isolated on white background":o==="colored-background"&&(l=`solid ${i} background`);const s=`${d}, ${e}, ${l}, fantasy item, d&d, 8k`.replace(/^, /,"");let m="https://api.getimg.ai/v1/flux-schnell/text-to-image",y={prompt:s,response_format:"b64"};t==="getimg-seedream"&&(m="https://api.getimg.ai/v1/seedream-v4/text-to-image"),console.log(`GeminiService: Generating with Getimg.ai (${t})`,m);try{const r=await fetch(m,{method:"POST",headers:{Authorization:`Bearer ${n}`,"Content-Type":"application/json",Accept:"application/json"},body:JSON.stringify(y)});if(!r.ok){const C=await r.json();throw new Error(`Getimg API Error: ${((f=C.error)==null?void 0:f.message)||r.statusText}`)}const b=`data:image/jpeg;base64,${(await r.json()).image}`,w=await(await fetch(b)).blob();return URL.createObjectURL(w)}catch{throw console.error("All Background Generation failed:",fallbackError),fallbackError}}async generateCardBackground(e,t=""){const o=`watercolor style, ${{Fire:"light orange",Nature:"light green",Arcane:"light purple",Divine:"light gold",Necrotic:"pale necrotic green",Industrial:"light metallic grey",Iron:"light rust","Old Scroll":"aged parchment",Elemental:"prismatic"}[e]||"light"} colored ornate ${e} style decorated old parchment paper texture, vintage card background, no white`,i=encodeURIComponent(o),c=`https://image.pollinations.ai/prompt/${i}?width=512&height=768&model=flux&seed=${Math.floor(Math.random()*1e4)}`;console.log(`GeminiService: Generating background for theme "${e}" (Flux)`,c);try{const d=await fetch(c);if(!d.ok)throw new Error(`Flux generation failed: ${d.status}`);const l=await d.blob();return URL.createObjectURL(l)}catch(d){if(console.warn("Background Flux generation failed:",d),t){console.log("GeminiService: Trying GetImg fallback...");try{const s="https://api.getimg.ai/v1/flux-schnell/text-to-image",m={prompt:o,response_format:"b64",width:512,height:768},y=await fetch(s,{method:"POST",headers:{Authorization:`Bearer ${t}`,"Content-Type":"application/json",Accept:"application/json"},body:JSON.stringify(m)});if(!y.ok)throw new Error(`GetImg failed: ${y.status}`);const r=`data:image/jpeg;base64,${(await y.json()).image}`,h=await(await fetch(r)).blob();return URL.createObjectURL(h)}catch(s){console.warn("Background GetImg fallback failed:",s)}}const l=`https://image.pollinations.ai/prompt/${i}?width=512&height=768&model=turbo&seed=${Math.floor(Math.random()*1e4)}`;console.log(`GeminiService: Generating background for theme "${e}" (Default/Turbo)`,l);try{const s=await fetch(l);if(!s.ok)throw new Error(`Default generation failed: ${s.status}`);const m=await s.blob();return URL.createObjectURL(m)}catch(s){throw console.error("All Background Generation failed:",s),s}}}}class ve{constructor(e){if(this.canvas=document.getElementById(e),!this.canvas)throw new Error(`Canvas element with id "${e}" not found`);this.ctx=this.canvas.getContext("2d"),this.template=new Image,this.template.src="assets/card-template.png",this.template.onerror=()=>{console.log("CardRenderer: Failed to load template from assets/, trying public/assets/..."),this.template.src="public/assets/card-template.png"},this.fontsLoaded=!1,document.fonts.ready.then(()=>{this.fontsLoaded=!0})}async setTemplate(e){return new Promise((t,a)=>{this.template.src=e,this.template.onload=()=>{console.log("CardRenderer: New template loaded"),t()},this.template.onerror=n=>{console.error("CardRenderer: Failed to load new template",n),a(n)}})}async render(e,t={}){console.log("CardRenderer: render called",{cardData:e,options:t});const a=parseInt(t.imageYOffset)||0,n=parseInt(t.name)||0,o=parseInt(t.type)||0,i=parseInt(t.rarity)||0,c=parseInt(t.gold)||0,d=parseInt(t.abilityY)||530,l=parseInt(t.fluffPadding)||20,s=parseInt(t.fontSize)||16,m=t.fontFamily||"Heebo",y={image:a,name:n,type:o,rarity:i,gold:c,abilityY:d,fluffPadding:l,fontSize:s,fontFamily:m,fontSizes:t.fontSizes};this.template.complete||(console.log("CardRenderer: Waiting for template..."),await new Promise(w=>{this.template.onload=w})),this.ctx.clearRect(0,0,this.canvas.width,this.canvas.height),console.log("CardRenderer: Drawing template");const f=t.backgroundScale||1,r=this.canvas.width*f,h=this.canvas.height*f,S=(this.canvas.width-r)/2,b=(this.canvas.height-h)/2;if(this.ctx.drawImage(this.template,S,b,r,h),e.imageUrl){console.log("CardRenderer: Drawing item image",e.imageUrl);try{await this.drawItemImage(e.imageUrl,y.image,t.imageScale,t.imageRotation,t.imageStyle,t.imageColor,t.imageFade,t.imageShadow)}catch(w){console.error("CardRenderer: Failed to draw image, continuing...",w)}}else console.log("CardRenderer: No image URL provided");console.log("CardRenderer: Drawing text");try{this.drawText(e,y)}catch(w){console.error("CardRenderer: Failed to draw text",w)}console.log("CardRenderer: Render complete")}async drawItemImage(e,t=0,a=1,n=0,o="natural",i="#ffffff",c=0,d=0){const l=new Image;l.crossOrigin="Anonymous",l.src=e;try{await new Promise((U,j)=>{const N=setTimeout(()=>j(new Error(`Image load timed out: ${e}`)),1e4);l.complete&&(clearTimeout(N),U()),l.onload=()=>{clearTimeout(N),U()},l.onerror=()=>{clearTimeout(N),j(new Error(`Failed to load image: ${e}`))}})}catch(U){console.warn("Image load error, skipping image:",U);return}const s=350,m=300,y=(this.canvas.width-s)/2,r=230+t,h=y+s/2,S=r+m/2,w=Math.min(s/l.width,m/l.height)*a,C=l.width*w,B=l.height*w,$=document.createElement("canvas"),Z=Math.sqrt(C*C+B*B);$.width=Z*1.5,$.height=Z*1.5;const L=$.getContext("2d"),P=$.width/2,A=$.height/2;L.save(),L.translate(P,A),L.rotate(n*Math.PI/180);let V=l;if(o==="no-background"&&(V=this.removeWhiteBackground(l)),o==="round-frame"?(L.beginPath(),L.arc(0,0,Math.min(C,B)/2,0,Math.PI*2),L.clip()):o==="square-frame"&&(L.beginPath(),L.rect(-C/2,-B/2,C,B),L.clip()),L.drawImage(V,-C/2,-B/2,C,B),(o==="round-frame"||o==="square-frame")&&(L.strokeStyle="#000000",L.lineWidth=2,L.stroke()),L.restore(),c>0){L.save(),L.globalCompositeOperation="destination-in";const U=Math.min(C,B)/2,j=Math.sqrt(C*C+B*B)/2,N=c/100,Q=U*.95,X=j*1.1,ee=X-(X-Q)*N,te=ee*(1-N*.8),G=L.createRadialGradient(P,A,Math.max(0,te),P,A,ee);G.addColorStop(0,"rgba(0, 0, 0, 1)"),G.addColorStop(1,"rgba(0, 0, 0, 0)"),L.fillStyle=G,L.fillRect(0,0,$.width,$.height),L.restore()}this.ctx.save(),d>0&&(this.ctx.shadowColor="rgba(0, 0, 0, 0.8)",this.ctx.shadowBlur=d*.5,this.ctx.shadowOffsetX=0,this.ctx.shadowOffsetY=d*.2),this.ctx.drawImage($,h-P,S-A),this.ctx.restore()}removeWhiteBackground(e){console.log("CardRenderer: removeWhiteBackground called");const t=document.createElement("canvas");t.width=e.width,t.height=e.height;const a=t.getContext("2d");a.drawImage(e,0,0);let n;try{n=a.getImageData(0,0,t.width,t.height)}catch(r){return console.error("CardRenderer: Failed to get image data (CORS issue?)",r),t}const o=n.data,i=t.width,c=t.height;console.log(`CardRenderer: Processing image ${i}x${c}`);const d=[],l=new Uint8Array(i*c),s=(r,h)=>(h*i+r)*4,m=r=>{const h=o[r],S=o[r+1],b=o[r+2];return h>200&&S>200&&b>200},y=r=>{const h=o[r],S=o[r+1],b=o[r+2],w=40;return h>255-w&&S>255-w&&b>255-w&&Math.abs(h-S)<w&&Math.abs(h-b)<w&&Math.abs(S-b)<w};for(let r=0;r<i;r++)[0,c-1].forEach(h=>{const S=s(r,h);m(S)&&(d.push({x:r,y:h}),l[h*i+r]=1)});for(let r=0;r<c;r++)[0,i-1].forEach(h=>{const S=s(h,r);!l[r*i+h]&&m(S)&&(d.push({x:h,y:r}),l[r*i+h]=1)});console.log(`CardRenderer: Found ${d.length} starting border pixels`);let f=0;for(;d.length>0;){const{x:r,y:h}=d.shift(),S=s(r,h);o[S+3]=0,f++;const b=[{x:r+1,y:h},{x:r-1,y:h},{x:r,y:h+1},{x:r,y:h-1}];for(const w of b)if(w.x>=0&&w.x<i&&w.y>=0&&w.y<c){const C=w.y*i+w.x;if(!l[C]){const B=s(w.x,w.y);y(B)&&(l[C]=1,d.push(w))}}}if(console.log(`CardRenderer: Flood Fill removed ${f} pixels`),f<i*c*.01){console.warn("CardRenderer: Flood Fill ineffective, running fallback threshold removal...");for(let r=0;r<o.length;r+=4){if(o[r+3]===0)continue;const h=o[r],S=o[r+1],b=o[r+2];h>230&&S>230&&b>230&&(o[r+3]=0)}}return a.putImageData(n,0,0),t}drawText(e,t){console.log("CardRenderer: drawText called",{data:e,offsets:t});const a=this.ctx,n=this.canvas.width,o=500,c={...{nameSize:48,typeSize:24,raritySize:24,abilityNameSize:28,abilityDescSize:24,descSize:22,goldSize:24},...t.fontSizes||{}};a.font=`bold ${c.nameSize}px "${t.fontFamily}"`,a.fillStyle="#2c1810",a.textAlign="center",a.fillText(e.name,n/2,160+t.name),a.font=`${c.typeSize}px "${t.fontFamily}"`;let d=`${e.typeHe}`;e.weaponDamage&&(d+=` â€¢ ${e.weaponDamage} ${e.damageType||""}`),e.armorClass&&(d+=` â€¢ AC ${e.armorClass}`),a.fillText(d,n/2,105+t.type),a.font=`${c.raritySize}px "${t.fontFamily}"`;const l=135+t.rarity;a.fillText(e.rarityHe,n/2,l);let s=t.abilityY;e.abilityName&&(a.font=`bold ${c.abilityNameSize}px "${t.fontFamily}"`,a.fillText(`${e.abilityName}:`,n/2,s),s+=c.abilityNameSize*1.2),e.abilityDesc&&(a.font=`${c.abilityDescSize}px "${t.fontFamily}"`,s=this.wrapTextCentered(e.abilityDesc,n/2,s,o,c.abilityDescSize*1.2)),s+=t.fluffPadding,e.description&&(a.font=`italic ${c.descSize}px "${t.fontFamily}"`,a.fillStyle="#5a4a3a",this.wrapTextCentered(e.description,n/2,s,o,c.descSize*1.2));const m=e.gold||"400";a.font=`bold ${c.goldSize}px Cinzel`,a.fillStyle="#d4af37",a.fillText(m,n/2,780+t.gold)}wrapTextCentered(e,t,a,n,o){const i=this.ctx,c=e.split(`
`);let d=a;return c.forEach(l=>{const s=l.split(" ");let m="";for(let y=0;y<s.length;y++){const f=m+s[y]+" ";i.measureText(f).width>n&&y>0?(i.fillText(m,t,d),m=s[y]+" ",d+=o):m=f}i.fillText(m,t,d),d+=o}),d}wrapText(e,t,a,n,o){const i=e.split(" ");let c="";for(let d=0;d<i.length;d++){const l=c+i[d]+" ";this.ctx.measureText(l).width>n&&d>0?(this.ctx.fillText(c,t,a),c=i[d]+" ",a+=o):c=l}this.ctx.fillText(c,t,a)}}const Ie=window.location.pathname.includes("/dnd-card-maker/")?"/dnd-card-maker/":"/";class fe{static async loadComponent(e,t){try{const a=Ie+t,n=await fetch(a);if(!n.ok)throw new Error(`Failed to load ${t}: ${n.statusText}`);const o=await n.text(),i=document.getElementById(e);i?(i.outerHTML=o,console.log(`âœ… Loaded: ${t}`)):console.error(`âŒ Placeholder ${e} not found`)}catch(a){throw console.error(`âŒ Error loading component ${t}:`,a),a}}static async loadAll(){console.log("ğŸ”„ Loading components...");const e=[{id:"header-placeholder",path:"components/header.html"},{id:"scroll-content-area",path:"components/scroll-menu.html"},{id:"sidebar-start-placeholder",path:"components/sidebar-start.html"},{id:"preview-placeholder",path:"components/preview-panel.html"},{id:"sidebar-end-placeholder",path:"components/sidebar-end.html"}];try{await Promise.all(e.map(t=>this.loadComponent(t.id,t.path))),console.log("âœ… All components loaded successfully"),window.areComponentsLoaded=!0,document.dispatchEvent(new Event("componentsLoaded"))}catch(t){console.error("âŒ Failed to load some components:",t)}}}document.readyState==="loading"?document.addEventListener("DOMContentLoaded",()=>fe.loadAll()):fe.loadAll();class ie{constructor(e={}){this.containerId=e.containerId||"scroll-content-area",this.scopeSelector=e.scopeSelector||"body",this.bodyClass=e.bodyClass||null,this.buttonSelector=e.buttonSelector||".stone-btn",this.scrollContainer=document.getElementById(this.containerId);const t=document.querySelector(this.scopeSelector);this.buttons=t?t.querySelectorAll(this.buttonSelector):[],this.scrollContainer?this.sections=this.scrollContainer.querySelectorAll(".scroll-section"):(this.sections=[],console.warn(`NavigationManager: Container #${this.containerId} not found`)),this.initialized=!1}init(){if(!this.initialized){if(!this.scrollContainer){console.warn(`NavigationManager: Container #${this.containerId} not found`);return}if(console.log(`NavigationManager: Initializing for #${this.containerId}. Scope: ${this.scopeSelector}`),this.buttons.length===0){console.error(`NavigationManager: NO BUTTONS FOUND for #${this.containerId} using selector '${this.buttonSelector}' inside '${this.scopeSelector}'`);const e=document.querySelector(this.scopeSelector);e?console.log(`NavigationManager: Scope found. InnerHTML length: ${e.innerHTML.length}`):console.error(`NavigationManager: Scope element '${this.scopeSelector}' NOT FOUND in DOM.`);return}console.log(`NavigationManager: Found ${this.buttons.length} buttons for #${this.containerId}. Attaching listeners...`),this.buttons.forEach(e=>{e.addEventListener("click",t=>{console.log(`NavigationManager: CLICK DETECTED on button for target '${e.dataset.target}'`),t.preventDefault(),t.stopPropagation();const a=e.dataset.target,n=this.scrollContainer.querySelector(`#${a}`);if(n)console.log("NavigationManager: Target section found. Toggling..."),this.toggleSection(e,n);else{console.error(`NavigationManager: Target section #${a} NOT FOUND in container #${this.containerId}`);const o=Array.from(this.scrollContainer.querySelectorAll(".scroll-section")).map(i=>i.id);console.log(`NavigationManager: Available sections: ${o.join(", ")}`)}})}),document.addEventListener("click",e=>{!this.scrollContainer.contains(e.target)&&!this.isClickOnMyButtons(e.target)&&this.closeAll()}),this.initialized=!0}}isClickOnMyButtons(e){let t=!1;return this.buttons.forEach(a=>{a.contains(e)&&(t=!0)}),t}toggleSection(e,t){const a=e.classList.contains("active");console.log(`NavigationManager: toggleSection. Current active state: ${a}`),this.closeAll(),a||(console.log("NavigationManager: Opening section..."),e.classList.add("active"),this.scrollContainer.classList.add("active"),t.classList.remove("hidden"),this.bodyClass&&document.body.classList.add(this.bodyClass),this.scrollContainer.offsetWidth)}closeAll(){this.buttons.forEach(e=>e.classList.remove("active")),this.scrollContainer&&this.scrollContainer.classList.remove("active"),this.sections.forEach(e=>e.classList.add("hidden")),this.bodyClass&&document.body.classList.remove(this.bodyClass)}}document.addEventListener("click",u=>{console.log("Global Click:",u.target),u.target.closest(".stone-btn")&&console.log("Global Click: Hit a .stone-btn!")});if(typeof window<"u"){window.NavigationManager=ie;let u=!1;const e=()=>{if(console.log("NavigationManager: initNav called"),u){console.log("NavigationManager: Already initialized, skipping.");return}u=!0,console.log("NavigationManager: Creating instances..."),setTimeout(()=>{window.mainNav=new ie({containerId:"main-scroll-area",scopeSelector:".main-nav"}),window.mainNav.init(),window.sidebarNav=new ie({containerId:"sidebar-scroll-area",scopeSelector:".sidebar-start .stone-menu"}),window.sidebarNav.init(),window.sidebarEndNav=new ie({containerId:"sidebar-end-scroll-area",scopeSelector:".sidebar-end .stone-menu",bodyClass:"left-menu-open"}),window.sidebarEndNav.init()},500)};window.areComponentsLoaded?(console.log("NavigationManager: Components already loaded, initializing."),e()):(console.log("NavigationManager: Waiting for componentsLoaded event."),document.addEventListener("componentsLoaded",e))}function Se(){const u=document.getElementById("api-key"),e=document.getElementById("api-key-indicator");u&&e&&((u.value.trim()||localStorage.getItem("gemini_api_key"))&&e.classList.add("active"),u.addEventListener("input",()=>{u.value.trim()?e.classList.add("active"):e.classList.remove("active")})),Ee()}function Ee(){document.querySelectorAll('input[type="range"]').forEach(e=>{const t=e.parentElement;getComputedStyle(t).position==="static"&&(t.style.position="relative");const a=document.createElement("div");a.className="slider-bubble",t.appendChild(a);const n=()=>{const o=parseFloat(e.value),i=parseFloat(e.min)||0,c=parseFloat(e.max)||100,d=(o-i)/(c-i),l=16,s=e.offsetWidth-l,m=e.offsetLeft+l/2+d*s;a.style.left=`${m}px`,a.textContent=o};e.addEventListener("input",()=>{n(),a.classList.add("visible")}),e.addEventListener("mousedown",()=>a.classList.add("visible")),e.addEventListener("touchstart",()=>a.classList.add("visible")),e.addEventListener("mouseup",()=>a.classList.remove("visible")),e.addEventListener("touchend",()=>a.classList.remove("visible")),e.addEventListener("blur",()=>a.classList.remove("visible")),setTimeout(n,100),window.addEventListener("resize",n)})}function O(u,e="info",t=3e3){let a=document.querySelector(".toast-container");a||(a=document.createElement("div"),a.className="toast-container",document.body.appendChild(a));const n=document.createElement("div");n.className=`toast ${e}`;const o={success:"âœ…",error:"âŒ",info:"â„¹ï¸",warning:"âš ï¸"};n.innerHTML=`
        <span class="toast-icon">${o[e]||o.info}</span>
        <span class="toast-message">${u}</span>
    `,a.appendChild(n),setTimeout(()=>{n.style.animation="fadeOut 0.3s ease-in forwards",n.addEventListener("animationend",()=>{n.remove(),a.children.length===0&&a.remove()})},t)}function _e(){const u=document.querySelectorAll(".floating-window"),e=document.querySelectorAll(".toolbar-btn[data-target]"),t=document.querySelectorAll(".window-close-btn");let a=100;e.forEach(n=>{n.addEventListener("click",()=>{const o=n.dataset.target,i=document.getElementById(o);i&&(i.classList.remove("hidden"),i.style.visibility="visible",a++,i.style.zIndex=a)})}),t.forEach(n=>{n.addEventListener("click",()=>{const o=n.dataset.target,i=document.getElementById(o);i&&i.classList.add("hidden")})}),u.forEach(n=>{const o=n.querySelector(".window-header");if(!o)return;n.addEventListener("mousedown",()=>{a++,n.style.zIndex=a});let i=!1,c,d,l,s,m=0,y=0;o.addEventListener("mousedown",f),document.addEventListener("mousemove",r),document.addEventListener("mouseup",S);function f(b){if(l=b.clientX-m,s=b.clientY-y,b.target===o||o.contains(b.target)){if(b.target.closest(".window-close-btn"))return;i=!0}}function r(b){i&&(b.preventDefault(),c=b.clientX-l,d=b.clientY-s,m=c,y=d,h(c,d,n))}function h(b,w,C){C.style.transform=`translate3d(${b}px, ${w}px, 0)`}function S(b){l=c,s=d,i=!1}})}class Ce{constructor(){this.state={cardData:null,settings:{fontSizes:{nameSize:48,typeSize:24,raritySize:24,abilityNameSize:28,abilityDescSize:24,descSize:22,goldSize:24},offsets:{name:50,type:27,rarity:-59,abilityY:578,fluffPadding:20,gold:0,imageYOffset:0,imageScale:1,imageRotation:0,imageFade:0,imageShadow:0,backgroundScale:1},style:{fontFamily:"Heebo",imageStyle:"natural",imageColor:"#ffffff"}},lastContext:null},this.listeners=[]}subscribe(e){return this.listeners.push(e),()=>{this.listeners=this.listeners.filter(t=>t!==e)}}notify(e){this.listeners.forEach(t=>t(this.state,e))}setCardData(e){this.state.cardData={...e},e.fontSizes&&(this.state.settings.fontSizes={...this.state.settings.fontSizes,...e.fontSizes}),e.offsets&&(this.state.settings.offsets={...this.state.settings.offsets,...e.offsets}),this.notify("cardData")}updateCardField(e,t){this.state.cardData&&(this.state.cardData[e]=t,this.notify(`cardData.${e}`))}updateOffset(e,t){this.state.settings.offsets[e]=t,this.notify(`settings.offsets.${e}`)}updateFontSize(e,t){const a=this.state.settings.fontSizes[e]||24;this.state.settings.fontSizes[e]=a+t*2,this.notify(`settings.fontSizes.${e}`)}updateStyle(e,t){this.state.settings.style[e]=t,this.notify(`settings.style.${e}`)}setLastContext(e){this.state.lastContext=e,this.notify("lastContext")}getState(){return this.state}saveCurrentCard(){if(!this.state.cardData)return;const e={cardData:this.state.cardData,settings:this.state.settings,savedAt:new Date().toISOString()};localStorage.setItem("dnd_current_card",JSON.stringify(e)),console.log("ğŸ’¾ Card saved to localStorage")}loadCurrentCard(){try{const e=localStorage.getItem("dnd_current_card");if(!e)return!1;const t=JSON.parse(e);if(t.cardData)return t.cardData.imageUrl&&t.cardData.imageUrl.startsWith("blob:")&&(console.log("ğŸ“‚ Clearing stale blob URL from saved card"),t.cardData.imageUrl=null),this.state.cardData=t.cardData,t.settings&&(this.state.settings={...this.state.settings,...t.settings}),this.notify("cardData"),console.log("ğŸ“‚ Card loaded from localStorage"),!0}catch(e){console.error("Failed to load card from localStorage:",e)}return!1}saveToHistory(){if(!this.state.cardData)return;const e=this.getHistory(),t={id:Date.now(),name:this.state.cardData.name||"×—×¤×¥ ×œ×œ× ×©×",cardData:this.state.cardData,settings:this.state.settings,savedAt:new Date().toISOString()};e.unshift(t),e.length>20&&e.pop(),localStorage.setItem("dnd_card_history",JSON.stringify(e)),console.log("ğŸ“š Card saved to history")}getHistory(){try{const e=localStorage.getItem("dnd_card_history");return e?JSON.parse(e):[]}catch(e){return console.error("Failed to load history:",e),[]}}loadFromHistory(e){const a=this.getHistory().find(n=>n.id===e);return a?(a.cardData.imageUrl&&a.cardData.imageUrl.startsWith("blob:")&&(console.log("ğŸ“‚ Clearing stale blob URL from history card"),a.cardData.imageUrl=null),this.state.cardData=a.cardData,a.settings&&(this.state.settings={...this.state.settings,...a.settings}),this.notify("cardData"),console.log("ğŸ“‚ Card loaded from history:",a.name),!0):!1}deleteFromHistory(e){const t=this.getHistory().filter(a=>a.id!==e);localStorage.setItem("dnd_card_history",JSON.stringify(t)),console.log("ğŸ—‘ï¸ Card deleted from history")}clearHistory(){localStorage.removeItem("dnd_card_history"),console.log("ğŸ—‘ï¸ History cleared")}clearCurrentCard(){localStorage.removeItem("dnd_current_card"),this.state.cardData=null,this.notify("cardData"),console.log("ğŸ—‘ï¸ Current card cleared")}}const x=new Ce;window.stateManager=x;class Le{constructor(e){this.renderer=e,this.init()}init(){x.subscribe((e,t)=>{this.handleStateChange(e,t)})}handleStateChange(e,t){t==="cardData"?(this.updateEditor(e.cardData),this.render(e)):t.startsWith("cardData.")?this.render(e):t.startsWith("settings.")&&(this.render(e),this.updateSettingsUI(e.settings))}updateEditor(e){if(!e)return;const t=(a,n)=>{const o=document.getElementById(a);o&&(o.value=n||"")};if(t("edit-name",e.name),t("edit-type",e.typeHe),t("edit-rarity",e.rarityHe),t("edit-ability-name",e.abilityName),t("edit-ability-desc",e.abilityDesc),t("edit-desc",e.description),t("edit-gold",e.gold),e.fontSizes)for(const[a,n]of Object.entries(e.fontSizes)){const o=document.getElementById(`${a}-display`);o&&(o.textContent=`${n}px`)}}updateSettingsUI(e){var t,a;if(e.offsets){const n=(o,i)=>{const c=document.getElementById(o);c&&(c.textContent=i)};n("image-scale-val",(t=e.offsets.imageScale)==null?void 0:t.toFixed(1)),n("edit-image-scale-val",(a=e.offsets.imageScale)==null?void 0:a.toFixed(1)),n("image-rotation-val",`${e.offsets.imageRotation}Â°`),n("edit-image-rotation-val",`${e.offsets.imageRotation}Â°`)}if(e.fontSizes)for(const[n,o]of Object.entries(e.fontSizes)){const i=document.getElementById(`${n}-display`);i&&(i.textContent=`${o}px`)}}async render(e){if(!e.cardData||!this.renderer)return;const t={...e.settings.offsets,fontSizes:e.settings.fontSizes,fontFamily:e.settings.style.fontFamily,imageStyle:e.settings.style.imageStyle,imageColor:e.settings.style.imageColor};await this.renderer.render(e.cardData,t)}}function pe(u){return u==="1-4"?"common":u==="5-10"?"uncommon":u==="11-16"?"rare":u==="17+"?"legendary":"common"}class xe{constructor(){this.zoomLevel=100,this.currentStep=0,this.init()}init(){this.setupFullscreen(),this.setupZoom(),this.setupKeyboardShortcuts()}setupFullscreen(){const e=document.getElementById("fullscreen-btn"),t=document.getElementById("close-fullscreen-btn"),a=document.getElementById("fullscreen-modal");document.getElementById("card-canvas"),document.getElementById("fullscreen-canvas"),e&&e.addEventListener("click",()=>this.openFullscreen()),t&&t.addEventListener("click",()=>this.closeFullscreen()),a&&a.addEventListener("click",n=>{n.target===a&&this.closeFullscreen()})}openFullscreen(){const e=document.getElementById("fullscreen-modal"),t=document.getElementById("card-canvas"),a=document.getElementById("fullscreen-canvas");if(!e||!t||!a)return;a.width=t.width,a.height=t.height,a.getContext("2d").drawImage(t,0,0),e.classList.remove("hidden"),this.zoomLevel=100,this.updateZoomDisplay(),a.style.transform="scale(1)"}closeFullscreen(){const e=document.getElementById("fullscreen-modal");e&&e.classList.add("hidden")}setupZoom(){const e=document.getElementById("zoom-in-btn"),t=document.getElementById("zoom-out-btn"),a=document.getElementById("zoom-reset-btn"),n=document.querySelector(".fullscreen-canvas-container");e&&e.addEventListener("click",()=>this.zoomIn()),t&&t.addEventListener("click",()=>this.zoomOut()),a&&a.addEventListener("click",()=>this.zoomReset()),n&&n.addEventListener("wheel",o=>{o.preventDefault(),o.deltaY<0?this.zoomIn():this.zoomOut()},{passive:!1})}zoomIn(){this.zoomLevel<300&&(this.zoomLevel+=25,this.applyZoom())}zoomOut(){this.zoomLevel>25&&(this.zoomLevel-=25,this.applyZoom())}zoomReset(){this.zoomLevel=100,this.applyZoom()}applyZoom(){const e=document.getElementById("fullscreen-canvas");e&&(e.style.transform=`scale(${this.zoomLevel/100})`),this.updateZoomDisplay()}updateZoomDisplay(){const e=document.getElementById("zoom-level");e&&(e.textContent=`${this.zoomLevel}%`)}setupKeyboardShortcuts(){document.addEventListener("keydown",e=>{const t=document.getElementById("fullscreen-modal"),a=t&&!t.classList.contains("hidden");(e.key==="f"||e.key==="F")&&(a||this.openFullscreen()),e.key==="Escape"&&a&&this.closeFullscreen(),a&&(e.key==="+"||e.key==="="?this.zoomIn():e.key==="-"?this.zoomOut():e.key==="0"&&this.zoomReset())})}updateProgress(e,t,a){const n=document.getElementById("progress-bar"),o=document.getElementById("loading-text"),i=document.querySelectorAll(".progress-steps .step"),c=document.querySelectorAll(".progress-steps .step-connector");n&&(n.style.width=`${t}%`),o&&a&&(o.textContent=a),i.forEach((d,l)=>{const s=l+1;d.classList.remove("active","completed"),s<e?d.classList.add("completed"):s===e&&d.classList.add("active")}),c.forEach((d,l)=>{l<e-1?d.classList.add("filled"):d.classList.remove("filled")}),this.currentStep=e}resetProgress(){this.updateProgress(0,0,"××ª×—×™×œ..."),document.querySelectorAll(".progress-steps .step-connector").forEach(t=>t.classList.remove("filled"))}}const J=new xe;window.previewManager=J;function Te(){console.log("ğŸ”§ Setting up event listeners (Refactored)...");const u=document.getElementById("generator-form"),e=document.getElementById("api-key"),t=document.getElementById("getimg-api-key"),a=document.getElementById("loading-overlay"),n=document.getElementById("empty-state"),o=document.getElementById("skeleton-overlay");document.getElementById("loading-text");const i=document.getElementById("error-message"),c=document.getElementById("download-btn"),d=document.getElementById("download-btn-toolbar"),l=document.getElementById("surprise-btn"),s=document.getElementById("regen-image-btn"),m=document.getElementById("regen-stats-btn"),y=document.getElementById("regenerate-controls"),f=document.getElementById("content-editor"),r=document.getElementById("image-model"),h={"edit-name":"name","edit-type":"typeHe","edit-rarity":"rarityHe","edit-ability-name":"abilityName","edit-ability-desc":"abilityDesc","edit-desc":"description","edit-gold":"gold"};Object.keys(h).forEach(g=>{const p=document.getElementById(g);p&&p.addEventListener("input",v=>{x.updateCardField(h[g],v.target.value)})});const S={"name-offset":"name","type-offset":"type","rarity-offset":"rarity","ability-offset":"abilityY","fluff-offset":"fluffPadding","gold-offset":"gold","image-offset":"imageYOffset","image-scale":"imageScale","edit-image-scale":"imageScale","image-rotation":"imageRotation","edit-image-rotation":"imageRotation","image-fade":"imageFade","image-shadow":"imageShadow","bg-scale":"backgroundScale"};Object.keys(S).forEach(g=>{const p=document.getElementById(g);p&&p.addEventListener("input",v=>{let E=parseFloat(v.target.value);if(g==="ability-offset"&&(E+=530),x.updateOffset(S[g],E),g.includes("scale")){const I=document.getElementById(`${g}-val`);I&&(I.textContent=E.toFixed(1))}else if(g.includes("rotation")){const I=document.getElementById(`${g}-val`);I&&(I.textContent=`${E}Â°`)}else if(g.includes("fade")||g.includes("shadow")){const I=document.getElementById(`${g}-val`);I&&(I.textContent=E)}})});const b=document.getElementById("font-family-select");b&&b.addEventListener("change",g=>{x.updateStyle("fontFamily",g.target.value)}),document.querySelectorAll(".font-btn").forEach(g=>{g.addEventListener("click",()=>{const p=g.dataset.target,v=g.classList.contains("font-increase")?1:-1;x.updateFontSize(p,v)})});const w=document.getElementById("image-style-option"),C=document.getElementById("image-color-picker-container"),B=document.getElementById("image-bg-color"),$=document.getElementById("color-palette"),Z=[{name:"Red",hex:"#ef4444"},{name:"Green",hex:"#22c55e"},{name:"Blue",hex:"#3b82f6"},{name:"Yellow",hex:"#eab308"},{name:"Purple",hex:"#a855f7"},{name:"Orange",hex:"#f97316"},{name:"Pink",hex:"#ec4899"},{name:"Cyan",hex:"#06b6d4"},{name:"White",hex:"#ffffff"},{name:"Black",hex:"#000000"},{name:"Gray",hex:"#6b7280"},{name:"Brown",hex:"#78350f"},{name:"Gold",hex:"#ffd700"},{name:"Silver",hex:"#c0c0c0"},{name:"Crimson",hex:"#991b1b"},{name:"Indigo",hex:"#4338ca"}];if($&&B){$.innerHTML="",Z.forEach(p=>{const v=document.createElement("div");v.className="color-option",v.style.backgroundColor=p.hex,v.title=p.name,v.dataset.name=p.name,v.addEventListener("click",()=>{document.querySelectorAll(".color-option").forEach(E=>E.classList.remove("selected")),v.classList.add("selected"),B.value=p.name,x.updateStyle("imageColor",p.name)}),$.appendChild(v)});const g=$.querySelector('[data-name="White"]');g&&(g.classList.add("selected"),B.value="White")}w&&(C&&C.classList.remove("hidden"),w.addEventListener("change",g=>{x.updateStyle("imageStyle",g.target.value)})),u&&u.addEventListener("submit",async g=>{var v,E,I,T;g.preventDefault();let p=e.value.trim();if(!p){O("× × ×œ×”×–×™×Ÿ ××¤×ª×— API","warning");return}localStorage.setItem("gemini_api_key",e.value.trim()),a.classList.remove("hidden"),n&&n.classList.add("hidden"),o&&o.classList.remove("hidden"),c&&(c.disabled=!0),y&&y.classList.add("hidden"),f&&f.classList.add("hidden"),i&&i.classList.add("hidden");try{const _=new FormData(u),k=document.getElementById("note-level"),D=document.getElementById("note-type"),z=document.getElementById("note-subtype"),M=(D==null?void 0:D.dataset.value)||_.get("type"),F=(z==null?void 0:z.dataset.value)||_.get("subtype"),q=(k==null?void 0:k.dataset.value)||_.get("level"),H=_.get("ability");let Y=M;F&&(Y=`${M} - ${F}`),M==="armor"&&!Y.toLowerCase().includes("armor")&&(Y+=" Armor");const ae=pe(q),se=new oe(p);J.updateProgress(1,10,"××ª×—×™×œ ×œ×—×©×•×‘ ×¢×œ ×¨×¢×™×•×Ÿ...");const re=x.getState().lastContext;re&&(console.log("Using visual context for generation:",re),J.updateProgress(1,15,"××¢×‘×“ ××ª ×”×ª××•× ×”..."));let ne=F;if(!ne&&window.OFFICIAL_ITEMS[M]){const R=window.OFFICIAL_ITEMS[M],K=[];for(const ue in R)Array.isArray(R[ue])&&K.push(...R[ue]);K.length>0&&(ne=K[Math.floor(Math.random()*K.length)],console.log(`Randomly selected subtype: ${ne}`))}J.updateProgress(2,30,"×¨×•×§×— ××ª ×”×¡×™×¤×•×¨...");const W=await se.generateItemDetails(q,M,ne,ae,H,re),de=document.getElementById("attunement");if(W.requiresAttunement=de?de.checked:!1,M==="weapon"){const R=(v=document.getElementById("weapon-damage"))==null?void 0:v.value,K=(E=document.getElementById("damage-type"))==null?void 0:E.value;R&&(W.weaponDamage=R),K&&(W.damageType=K)}else if(M==="armor"){const R=(I=document.getElementById("armor-class"))==null?void 0:I.value;R&&(W.armorClass=R)}J.updateProgress(3,60,"××¦×™×™×¨ ××ª ×”×—×¤×¥...");const le=r?r.value:"flux",me=((T=document.getElementById("image-style"))==null?void 0:T.value)||"realistic",ge=w?w.value:"natural",he=B?B.value:"#ffffff";let ce;if(le.startsWith("getimg-")){let R=t?t.value.trim():"";if(!R)throw new Error("Missing GetImg API Key");localStorage.setItem("getimg_api_key",t.value.trim()),ce=await se.generateImageGetImg(W.visualPrompt,le,me,R,ge,he)}else ce=await se.generateItemImage(W.visualPrompt,le,me,ge,he);const be={...W,gold:W.gold||"1000",imageUrl:ce,originalParams:{level:q,type:Y,rarity:ae,ability:H}};x.setCardData(be),x.saveCurrentCard(),x.saveToHistory(),J.updateProgress(4,100,"×”×•×©×œ×! âœ¨"),await new Promise(R=>setTimeout(R,500)),a.classList.add("hidden"),o&&o.classList.add("hidden"),y&&y.classList.remove("hidden"),f&&f.classList.remove("hidden"),c&&(c.disabled=!1),J.resetProgress()}catch(_){console.error("Generation Error:",_),a.classList.add("hidden"),o&&o.classList.add("hidden"),c&&(c.disabled=!1),O(_.message,"error"),f&&f.classList.remove("hidden")}});const L=()=>{const g=document.getElementById("card-canvas");if(g){const p=document.createElement("a");p.download=`dnd-item-${Date.now()}.png`,p.href=g.toDataURL(),p.click()}};c&&c.addEventListener("click",L),d&&d.addEventListener("click",L),l&&l.addEventListener("click",()=>{const g=Object.keys(window.OFFICIAL_ITEMS||{});if(g.length===0)return;const p=g[Math.floor(Math.random()*g.length)],v=document.getElementById("item-type");if(v){v.value=p;const D=document.querySelector(`.scroll-option[data-value="${p}"]`);D&&D.click()}const E=window.OFFICIAL_ITEMS[p],I=[];for(const D in E)I.push(...E[D]);const T=I[Math.floor(Math.random()*I.length)],_=document.getElementById("item-subtype");_&&(_.value=T);const k=["1-4","5-10","11-16","17+"];document.getElementById("item-level").value=k[Math.floor(Math.random()*k.length)],document.getElementById("item-ability").value="",u.dispatchEvent(new Event("submit"))}),s&&s.addEventListener("click",async()=>{var v,E,I;const g=x.getState();if(!g.cardData)return;let p=e.value.trim();if(!p){O("× × ×œ×”×–×™×Ÿ ××¤×ª×— API","warning");return}try{s.disabled=!0;const T=s.innerHTML;s.innerHTML='<span class="icon">â³</span> ×¦×™×•×¨...';const _=new oe(p),k=r?r.value:"flux",D=((v=document.getElementById("image-style"))==null?void 0:v.value)||"realistic",z=((E=document.getElementById("image-style-option"))==null?void 0:E.value)||"natural",M=((I=document.getElementById("image-bg-color"))==null?void 0:I.value)||"#ffffff";let F;if(k.startsWith("getimg-")){let H=t?t.value.trim():"";if(!H)throw new Error("Missing GetImg API Key");F=await _.generateImageGetImg(g.cardData.visualPrompt,k,D,H,z,M)}else F=await _.generateItemImage(g.cardData.visualPrompt,k,D,z,M);const q={...g.cardData,imageUrl:F};x.setCardData(q),O("×ª××•× ×” ×—×“×©×” × ×•×¦×¨×”!","success")}catch(T){console.error("Regen Image Error:",T),O("×©×’×™××” ×‘×™×¦×™×¨×ª ×ª××•× ×”","error")}finally{s.disabled=!1,s.innerHTML='<span class="icon">ğŸ¨</span> ××¨××”'}}),m&&m.addEventListener("click",async()=>{const g=x.getState();if(!g.cardData)return;let p=e.value.trim();if(!p){O("× × ×œ×”×–×™×Ÿ ××¤×ª×— API","warning");return}try{m.disabled=!0;const v=m.innerHTML;m.innerHTML='<span class="icon">â³</span> ×—×•×©×‘...';const E=new oe(p),I=g.cardData.originalParams||{},T=document.getElementById("note-level"),_=document.getElementById("note-type"),k=document.getElementById("note-subtype"),D=(T==null?void 0:T.dataset.value)||I.level||"1-4",z=(_==null?void 0:_.dataset.value)||I.type||"wondrous",M=(k==null?void 0:k.dataset.value)||I.subtype||"",F=pe(D),q=I.ability||"",H=g.lastContext;H&&console.log("Regenerating stats with visual context:",H);const Y=await E.generateItemDetails(D,z,M,F,q,H),ae={...Y,gold:Y.gold||"1000",imageUrl:g.cardData.imageUrl,originalParams:I};x.setCardData(ae),O("×ª×›×•× ×•×ª ×—×“×©×•×ª × ×•×¦×¨×•!","success")}catch(v){console.error("Regen Stats Error:",v),O("×©×’×™××” ×‘×™×¦×™×¨×ª ×ª×›×•× ×•×ª","error")}finally{m.disabled=!1,m.innerHTML='<span class="icon">ğŸ“</span> ×ª×›×•× ×•×ª'}});const P=document.getElementById("item-type");P&&P.addEventListener("change",g=>{const p=g.target.value,v=document.getElementById("item-subtype"),E=document.getElementById("subtype-container");if(v&&window.OFFICIAL_ITEMS[p]){E.classList.remove("hidden"),v.innerHTML='<option value="">-- ×‘×—×¨ ×—×¤×¥ --</option>';const _=window.OFFICIAL_ITEMS[p];for(const[k,D]of Object.entries(_)){const z=document.createElement("optgroup");z.label=k,D.forEach(M=>{const F=document.createElement("option");F.value=M,F.textContent=M,z.appendChild(F)}),v.appendChild(z)}}else E&&E.classList.add("hidden");const I=document.getElementById("weapon-fields"),T=document.getElementById("armor-fields");I&&I.classList.add("hidden"),T&&T.classList.add("hidden"),p==="weapon"&&I?I.classList.remove("hidden"):p==="armor"&&T&&T.classList.remove("hidden")});const A=document.getElementById("generate-bg-btn"),V=document.getElementById("reset-bg-btn"),U=document.getElementById("bg-theme-select");x.notify("cardData"),A&&A.addEventListener("click",async()=>{var E;const g=U?U.value:"Fire",p=e.value.trim();let v=((E=document.getElementById("getimg-api-key"))==null?void 0:E.value.trim())||"";try{A.disabled=!0,A.textContent="××™×™×¦×¨ ×¨×§×¢...";const T=await new oe(p||"dummy").generateCardBackground(g,v);if(window.cardRenderer){await window.cardRenderer.setTemplate(T);const _=x.getState();_.cardData?x.notify("cardData"):window.cardRenderer.render({},_.settings.offsets)}O("×¨×§×¢ ×—×“×© × ×•×¦×¨ ×‘×”×¦×œ×—×”!","success")}catch(I){console.error("Background Generation Error:",I),O("×©×’×™××” ×‘×™×¦×™×¨×ª ×¨×§×¢","error")}finally{A.disabled=!1,A.textContent="×¦×•×¨ ×¨×§×¢"}}),V&&V.addEventListener("click",async()=>{if(window.cardRenderer){await window.cardRenderer.setTemplate("assets/card-template.png");const g=x.getState();g.cardData?x.notify("cardData"):window.cardRenderer.render({},g.settings.offsets),O("×¨×§×¢ ×—×–×¨ ×œ×‘×¨×™×¨×ª ××—×“×œ","info")}});const j=document.getElementById("sticky-note"),N=document.getElementById("note-level"),Q=document.getElementById("note-type"),X=document.getElementById("note-subtype"),ee=document.getElementById("item-level"),te=document.getElementById("item-subtype");function G(){var E,I,T;if(!j)return;const g=document.getElementById("item-level"),p=document.getElementById("item-type"),v=document.getElementById("item-subtype");if(N&&g){const _=((E=g.options[g.selectedIndex])==null?void 0:E.text)||g.value;N.textContent=_.split("(")[0].trim(),N.dataset.value=g.value}if(Q&&p){const _=((I=p.options[p.selectedIndex])==null?void 0:I.text)||p.value;Q.textContent=_.split("(")[0].trim(),Q.dataset.value=p.value}if(X&&v){const _=v.value?((T=v.options[v.selectedIndex])==null?void 0:T.text)||v.value:"-";X.textContent=_,X.dataset.value=v.value||""}j.classList.remove("hidden")}ee&&ee.addEventListener("change",G),P&&P.addEventListener("change",()=>{setTimeout(G,50)}),te&&te.addEventListener("change",G),setTimeout(G,500)}class Be{constructor(e){this.renderer=e,this.gridImages=["assets/5.jpeg","assets/6.jpeg","assets/7.png","assets/8.png","assets/_9_theme______________dnd_____________________cbfz6tpc0dv5spx1gr2g_0.jpeg","assets/_9_theme______________dnd_____________________g97xoxyyadej6tpyx5ue_1.png","assets/_9_theme______________dnd_____________________ixd0s7wfxvmxqz9kio7b_1.jpeg","assets/_9_theme______________dnd_____________________mvhaww630hwswh556ktn_0.jpeg","assets/_9_theme______________dnd_____________________qg2kfq9timfy3fonh9cb_0.png"],this.modal=document.getElementById("bg-selection-modal"),this.gridDisplay=document.getElementById("bg-grid-display"),this.themesContainer=document.getElementById("bg-themes-container"),this.openBtn=document.getElementById("ready-made-bg-btn"),this.closeBtn=document.getElementById("close-bg-modal"),this.init()}init(){this.openBtn&&this.openBtn.addEventListener("click",()=>this.openModal()),this.closeBtn&&this.closeBtn.addEventListener("click",()=>this.closeModal()),this.modal&&this.modal.addEventListener("click",e=>{e.target===this.modal&&this.closeModal()})}async openModal(){this.modal&&(this.modal.classList.remove("hidden"),this.gridDisplay.children.length===0&&await this.loadAllGrids())}closeModal(){this.modal&&this.modal.classList.add("hidden")}async loadAllGrids(){this.gridDisplay.innerHTML='<div style="color: #d4af37; grid-column: 1/-1; text-align: center;">×˜×•×¢×Ÿ ×¨×§×¢×™×...</div>';const e=[];for(const t of this.gridImages)try{const a=await this.sliceGrid(t);e.push(...a)}catch(a){console.error(`Failed to load grid ${t}:`,a)}this.renderGrid(e)}renderGrid(e){this.gridDisplay.innerHTML="",e.forEach((t,a)=>{const n=document.createElement("div");n.className="bg-thumbnail",n.style.cursor="pointer",n.style.border="2px solid transparent",n.style.borderRadius="8px",n.style.overflow="hidden",n.style.transition="all 0.2s",n.style.position="relative",n.style.aspectRatio="2/3";const o=document.createElement("img");o.src=t,o.style.width="100%",o.style.height="100%",o.style.objectFit="cover",n.appendChild(o),n.addEventListener("mouseenter",()=>{n.style.borderColor="#d4af37",n.style.transform="scale(1.05)",n.style.zIndex="10"}),n.addEventListener("mouseleave",()=>{n.style.borderColor="transparent",n.style.transform="scale(1)",n.style.zIndex="1"}),n.addEventListener("click",()=>{this.selectBackground(t)}),this.gridDisplay.appendChild(n)})}selectBackground(e){this.renderer&&(this.renderer.setTemplate(e),window.stateManager?(window.stateManager.setLastContext(e),window.stateManager.notify("cardData")):this.renderer.render({},{})),this.closeModal()}sliceGrid(e){return new Promise((t,a)=>{const n=new Image;n.crossOrigin="Anonymous",n.onload=()=>{const o=[],d=n.width/n.height<.6?4:3,l=n.width/3,s=n.height/d;console.log(`Processing grid: ${e}`),console.log(`Image Size: ${n.width}x${n.height}`),console.log(`Cell Size: ${l.toFixed(2)}x${s.toFixed(2)}`);const m=2/3;let y,f;l/s>m?(f=s,y=f*m):(y=l,f=y/m);const h=(l-y)/2,S=(s-f)/2;for(let b=0;b<d;b++)for(let w=0;w<3;w++){const C=document.createElement("canvas");C.width=1e3,C.height=1500;const B=C.getContext("2d"),$=w*l+h,Z=b*s+S;B.drawImage(n,$,Z,y,f,0,0,C.width,C.height),o.push(C.toDataURL("image/jpeg",.9))}t(o)},n.onerror=a,n.src=e})}}function ye(){console.log("ğŸš€ Initializing app (Refactored)...");let u;try{u=new ve("card-canvas"),window.cardRenderer=u}catch(a){console.error("Renderer Init Error:",a),O("×©×’×™××” ×‘×˜×¢×™× ×ª ×”×§× ×‘×¡: "+a.message,"error");return}const e=new Le(u);if(window.uiManager=e,!x.loadCurrentCard())x.setCardData({name:"×©× ×”×—×¤×¥",typeHe:"×¡×•×’ ×—×¤×¥",rarityHe:"× ×“×™×¨×•×ª",description:"×”×—×¤×¥ ×©×œ×š ×™×•×¤×™×¢ ×›××Ÿ...",gold:"-"});else{O("ğŸ“‚ ×§×œ×£ ××—×¨×•×Ÿ × ×˜×¢×Ÿ!","info");const a=document.getElementById("regenerate-controls"),n=document.getElementById("content-editor");a&&a.classList.remove("hidden"),n&&n.classList.remove("hidden")}Se(),setTimeout(_e,100),window.backgroundManager=new Be(u),Te(),O("×”××¢×¨×›×ª ××•×›× ×”!","success")}window.onerror=function(u,e,t,a,n){return console.error("Global Error:",u,e,t,a,n),!1};window.addEventListener("unhandledrejection",function(u){console.error("Unhandled Rejection:",u.reason)});window.areComponentsLoaded?ye():document.addEventListener("componentsLoaded",ye);
